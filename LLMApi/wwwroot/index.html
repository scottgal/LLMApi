<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLMock API - Dynamic Context Demo</title>
    <script src="https://unpkg.com/htmx.org@2.0.1"></script>
    <script src="https://unpkg.com/htmx-ext-json-enc@2.0.1/json-enc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .data-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }

        .timestamp {
            color: #666;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* JSON syntax highlighting */
        .json-display {
            background: #282c34;
            color: #abb2bf;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .json-key {
            color: #e06c75;
        }

        .json-string {
            color: #98c379;
        }

        .json-number {
            color: #d19a66;
        }

        .json-boolean {
            color: #56b6c2;
        }

        .json-null {
            color: #c678dd;
        }
    </style>
</head>
<body hx-ext="signalr">
    <h1>LLMock API - Dynamic Context Demo</h1>
    <p class="subtitle">Create custom SignalR contexts with plain English descriptions</p>

    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px;">
        <a href="/" style="color: white; background: #007bff; text-decoration: none; padding: 8px 16px; border-radius: 4px;">SignalR Demo</a>
        <a href="/streaming.html" style="color: #007bff; text-decoration: none; padding: 8px 16px; border-radius: 4px; transition: background 0.2s;">SSE Streaming Demo</a>
    </div>

    <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
        <h3 style="margin-top: 0;">How It Works</h3>
        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
            <li><strong>Enter a context name</strong> - A unique identifier for your data stream (e.g., "weather", "stocks", "sensors")</li>
            <li><strong>Describe what you want</strong> - Use plain English to describe the data structure you need</li>
            <li><strong>Click Create & Subscribe</strong> - The LLM generates appropriate JSON schema and starts streaming data</li>
            <li><strong>Watch live updates</strong> - New data appears every 5 seconds in real-time!</li>
        </ol>

        <details style="margin-top: 15px;" open>
            <summary style="cursor: pointer; font-weight: 500; color: #007bff;">Quick Start Examples (Click to Launch)</summary>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 14px;">IoT Sensors</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #666;">
                            Temperature sensors with device ID, current temperature in Celsius, battery percentage, and last reading timestamp
                        </p>
                    </div>
                    <button type="button" class="quick-start-btn" data-name="iot-sensors" data-description="Temperature sensors with device ID, current temperature in Celsius, battery percentage, and last reading timestamp" style="background: #28a745; white-space: nowrap;">Launch</button>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 14px;">Stock Market</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #666;">
                            Real-time stock prices with ticker symbol, current price, daily change percentage, trading volume, and market cap
                        </p>
                    </div>
                    <button type="button" class="quick-start-btn" data-name="stock-market" data-description="Real-time stock prices with ticker symbol, current price, daily change percentage, trading volume, and market cap" style="background: #28a745; white-space: nowrap;">Launch</button>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 14px;">E-commerce Orders</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #666;">
                            Recent orders with order ID, customer name, order total, status (pending/shipped/delivered), and items array containing SKU and quantity
                        </p>
                    </div>
                    <button type="button" class="quick-start-btn" data-name="ecommerce-orders" data-description="Recent orders with order ID, customer name, order total, status (pending/shipped/delivered), and items array containing SKU and quantity" style="background: #28a745; white-space: nowrap;">Launch</button>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 14px;">Server Metrics</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #666;">
                            Server monitoring data with hostname, CPU usage percentage, memory usage in GB, disk space available, and active connections count
                        </p>
                    </div>
                    <button type="button" class="quick-start-btn" data-name="server-metrics" data-description="Server monitoring data with hostname, CPU usage percentage, memory usage in GB, disk space available, and active connections count" style="background: #28a745; white-space: nowrap;">Launch</button>
                </div>

                <div style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 4px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 14px;">Gaming Leaderboard</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #666;">
                            Gaming leaderboard entries with player name, score, rank, level, country code, and online status
                        </p>
                    </div>
                    <button type="button" class="quick-start-btn" data-name="gaming-leaderboard" data-description="Gaming leaderboard entries with player name, score, rank, level, country code, and online status" style="background: #28a745; white-space: nowrap;">Launch</button>
                </div>
            </div>
        </details>

        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: 500; color: #007bff;">View API Documentation</summary>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">
                <h4 style="margin-top: 0;">Management API Endpoints</h4>

                <p><strong>POST /api/mock/contexts</strong> - Create new context</p>
                <pre style="background: #fff; padding: 10px; border-radius: 3px; overflow-x: auto;">
{
  "name": "weather",
  "description": "Weather data with temp, condition, humidity"
}</pre>

                <p><strong>GET /api/mock/contexts</strong> - List all contexts</p>
                <p><strong>GET /api/mock/contexts/{name}</strong> - Get specific context</p>
                <p><strong>DELETE /api/mock/contexts/{name}</strong> - Delete context</p>

                <h4 style="margin-top: 15px;">SignalR Hub</h4>
                <p><strong>Hub URL:</strong> /hub/mock</p>
                <p><strong>Methods:</strong></p>
                <ul style="margin: 5px 0;">
                    <li><code>SubscribeToContext(contextName)</code> - Start receiving data</li>
                    <li><code>UnsubscribeFromContext(contextName)</code> - Stop receiving data</li>
                </ul>
                <p><strong>Events:</strong></p>
                <ul style="margin: 5px 0;">
                    <li><code>DataUpdate</code> - Receives generated data</li>
                    <li><code>Subscribed</code> - Subscription confirmation</li>
                    <li><code>Unsubscribed</code> - Unsubscription confirmation</li>
                </ul>
            </div>
        </details>

        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: 500; color: #007bff;">View JavaScript Integration Example</summary>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <pre style="background: #fff; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px;">
<code>// Connect to SignalR hub
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/hub/mock")
    .withAutomaticReconnect()
    .build();

// Listen for data updates
connection.on("DataUpdate", (message) => {
    console.log(`Context: ${message.context}`);
    console.log(`Data:`, message.data);
    console.log(`Timestamp: ${message.timestamp}`);
});

// Start connection
await connection.start();

// Create a new context
const response = await fetch("/api/mock/contexts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
        name: "mydata",
        description: "Your data description here"
    })
});

// Subscribe to receive updates
await connection.invoke("SubscribeToContext", "mydata");

// Unsubscribe when done
await connection.invoke("UnsubscribeFromContext", "mydata");</code></pre>
            </div>
        </details>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card">
            <h2>Create Context</h2>
            <form id="contextForm"
                  hx-post="/api/mock/contexts"
                  hx-encoding="json"
                  hx-swap="none"
                  hx-vals="js:{ method: 'GET', path: '/' + document.getElementById('contextName').value }"
                  hx-on:htmx:beforeRequest="this.querySelector('button[type=submit]').disabled=true; this.querySelector('button[type=submit]').textContent='Creating...';"
                  hx-on:htmx:afterRequest="this.querySelector('button[type=submit]').disabled=false; this.querySelector('button[type=submit]').textContent='Create & Subscribe';"
                  hx-on:htmx:afterOnLoad="if (event.detail.xhr.status===200) { htmx.trigger(document.body, 'signalr:subscribe', {detail:{context: document.getElementById('contextName').value}}); document.getElementById('formStatus').textContent='Context \' ' + document.getElementById('contextName').value + ' \' created successfully!'; document.getElementById('formStatus').className='status show success'; this.reset(); setTimeout(()=>document.getElementById('formStatus').classList.remove('show'), 5000);} else { try { const res=JSON.parse(event.detail.xhr.responseText); document.getElementById('formStatus').textContent=res.error || 'Failed to create context'; } catch { document.getElementById('formStatus').textContent='Failed to create context'; } document.getElementById('formStatus').className='status show error'; }">
                <div class="form-group">
                    <label for="contextName">Context Name *</label>
                    <input type="text" id="contextName" name="name" required
                           placeholder="e.g., mydata, sensors, stocks" />
                    <p class="help-text">Used to identify this SignalR context</p>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" required
                              placeholder="Describe what data you want in plain English&#10;&#10;Example: I want stock market data with symbol, price, change percentage, and trading volume"></textarea>
                    <p class="help-text">The LLM will generate appropriate JSON schema from this</p>
                </div>

                <button type="submit">Create & Subscribe</button>

                <div id="formStatus" class="status"></div>
            </form>
        </div>

        <div class="card">
            <h2>
                Active Contexts
                <button type="button" onclick="refreshContextList()" style="background: #6c757d; padding: 5px 10px; font-size: 12px; margin-left: 10px;">Refresh</button>
            </h2>
            <div id="contextList" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #999; text-align: center; padding: 20px;">Loading...</p>
            </div>
        </div>

        <div class="card">
            <h2>
                Live Data
                <span id="connectionStatus" class="connection-status disconnected">Disconnected</span>
            </h2>
            <div id="currentContext" style="margin-bottom: 10px; color: #666;">
                No context selected
            </div>
            <div id="dataDisplay" class="data-display">
                <p style="color: #999;">Create a context to start receiving data...</p>
            </div>
        </div>
    </div>

    <script>
    // Track subscribed contexts to prevent duplicates
    window.__subscribedContexts = new Set();

    (function(){
      // HTMX SignalR extension: manages a single connection and dispatches HTMX-friendly events
      htmx.defineExtension('signalr', {
        init: function(api){
          if (window.__srConn) { return; }
          var connection = new signalR.HubConnectionBuilder().withUrl('/hub/mock').withAutomaticReconnect().build();
          window.__srConn = connection;

          connection.on('DataUpdate', function(message){
            htmx.trigger(document.body, 'signalr:data', message);
          });
          connection.on('Subscribed', function(message){
            htmx.trigger(document.body, 'signalr:subscribed', { detail: message });
          });
          connection.onclose(function(){ htmx.trigger(document.body, 'signalr:disconnected'); });
          connection.onreconnected(function(){ htmx.trigger(document.body, 'signalr:connected'); });

          connection.start()
            .then(function(){ htmx.trigger(document.body, 'signalr:connected'); })
            .catch(function(err){ htmx.trigger(document.body, 'signalr:error', { detail: { error: (err && (err.message||err)) } }); });

          // Subscribe/Unsubscribe handlers
          document.body.addEventListener('signalr:subscribe', function(e){
            var ctx = e.detail && e.detail.context;
            if (!ctx) return;
            connection.invoke('SubscribeToContext', ctx)
              .catch(function(err){ htmx.trigger(document.body, 'signalr:error', { detail: { error: (err && (err.message||err)) } }); });
          });
          document.body.addEventListener('signalr:unsubscribe', function(e){
            var ctx = e.detail && e.detail.context;
            if (!ctx) return;
            connection.invoke('UnsubscribeFromContext', ctx)
              .catch(function(err){ htmx.trigger(document.body, 'signalr:error', { detail: { error: (err && (err.message||err)) } }); });
          });
        }
      });

      function updateConnectionStatus(connected) {
        var statusEl = document.getElementById('connectionStatus');
        if (!statusEl) return;
        statusEl.textContent = connected ? 'Connected' : 'Disconnected';
        statusEl.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
      }

      function displayData(message) {
        console.log('displayData received:', message);
        var display = document.getElementById('dataDisplay');
        if (!display) return;

        // Update current context display
        var ctxEl = document.getElementById('currentContext');
        if (ctxEl && message.context) {
          ctxEl.textContent = 'Receiving data from: ' + message.context;
        }

        // Convert Unix timestamp (milliseconds) to readable time
        var ts = 'Unknown time';
        var context = message.context || 'unknown';

        if (message.timestamp && typeof message.timestamp === 'number') {
          var date = new Date(message.timestamp);
          ts = date.toLocaleTimeString();
        }

        // Extract just the data field for display
        var dataToShow = message.data || message;
        var jsonStr = JSON.stringify(dataToShow, null, 2);

        var item = document.createElement('div');
        item.className = 'data-item';
        var header = document.createElement('div');
        header.className = 'timestamp';
        header.textContent = ts + ' - ' + context;
        var pre = document.createElement('pre');
        pre.className = 'json-display';
        pre.innerHTML = syntaxHighlight(jsonStr);
        item.appendChild(header);
        item.appendChild(pre);
        display.insertBefore(item, display.firstChild);
        while (display.children.length > 10) {
          display.removeChild(display.lastChild);
        }
      }

      // Simple JSON syntax highlighting
      function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'json-number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'json-key';
            } else {
              cls = 'json-string';
            }
          } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
          } else if (/null/.test(match)) {
            cls = 'json-null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        });
      }

      function showStatus(message, isError) {
        var status = document.getElementById('formStatus');
        if (!status) return;
        status.textContent = message;
        status.className = 'status show ' + (isError ? 'error' : 'success');
        setTimeout(function(){ status.classList.remove('show'); }, 5000);
      }

      // Wire events to UI
      document.body.addEventListener('signalr:connected', function(){
        updateConnectionStatus(true);
        refreshContextList();
      });
      document.body.addEventListener('signalr:disconnected', function(){ updateConnectionStatus(false); });
      document.body.addEventListener('signalr:subscribed', function(e){
        var ctx = e.detail && e.detail.context;
        var ctxEl = document.getElementById('currentContext');
        if (ctxEl) ctxEl.textContent = 'Subscribed to: ' + (ctx || '');
        var display = document.getElementById('dataDisplay');
        if (display) display.innerHTML = '<p style="color: #999;">Waiting for data...</p>';
        refreshContextList();
      });
      document.body.addEventListener('signalr:data', function(e){ displayData(e.detail); });

      // Enhance the form UX with HTMX events
      var form = document.getElementById('contextForm');
      if (form) {
        form.addEventListener('htmx:beforeRequest', function(){
          var btn = form.querySelector('button[type=submit]');
          if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }
        });
        form.addEventListener('htmx:afterRequest', function(){
          var btn = form.querySelector('button[type=submit]');
          if (btn) { btn.disabled = false; btn.textContent = 'Create & Subscribe'; }
        });
        form.addEventListener('htmx:afterOnLoad', function(ev){
          var xhr = ev.detail && ev.detail.xhr;
          var ctxNameInput = document.getElementById('contextName');
          var ctxName = ctxNameInput ? ctxNameInput.value : '';
          if (xhr && xhr.status === 200) {
            showStatus("Context '" + ctxName + "' created successfully!");
            htmx.trigger(document.body, 'signalr:subscribe', { detail: { context: ctxName }});
            form.reset();
          } else {
            var msg = 'Failed to create context';
            try { var res = JSON.parse(xhr.responseText); if (res && res.error) msg = res.error; } catch (e) {}
            showStatus(msg, true);
          }
        });
      }

      // Quick start button handlers
      document.querySelectorAll('.quick-start-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var name = this.getAttribute('data-name');
          var description = this.getAttribute('data-description');

          btn.disabled = true;
          btn.textContent = 'Creating...';

          fetch('/api/mock/contexts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, description: description })
          })
          .then(function(response) {
            if (response.ok) {
              console.log('Context created:', name);

              // Wait for connection to be ready, then subscribe directly
              var conn = window.__srConn;
              if (conn && conn.state === 'Connected') {
                console.log('Directly invoking SubscribeToContext for:', name);
                conn.invoke('SubscribeToContext', name)
                  .then(function() {
                    console.log('Successfully subscribed to:', name);
                    showStatus("Context '" + name + "' created and subscribed!");
                    refreshContextList();
                  })
                  .catch(function(err) {
                    console.error('Subscribe error:', err);
                    showStatus('Subscribed to context but got error: ' + err.message, true);
                  });
              } else {
                console.error('SignalR connection not ready, state:', conn ? conn.state : 'no connection');
                showStatus("Context '" + name + "' created, but subscription failed. Try clicking Connect manually.", true);
                refreshContextList();
              }
            } else {
              return response.json().then(function(data) {
                showStatus(data.error || 'Failed to create context', true);
              });
            }
          })
          .catch(function(err) {
            showStatus('Error: ' + err.message, true);
          })
          .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Launch';
          });
        });
      });
    })();

    // Context list management functions
    function refreshContextList() {
      fetch('/api/mock/contexts')
        .then(function(response) { return response.json(); })
        .then(function(data) {
          var contextList = document.getElementById('contextList');
          if (!contextList) return;

          if (!data.contexts || data.contexts.length === 0) {
            contextList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No contexts created yet</p>';
            return;
          }

          var html = '';
          data.contexts.forEach(function(ctx) {
            var statusColor = ctx.isActive ? '#28a745' : '#dc3545';
            var statusText = ctx.isActive ? 'Active' : 'Stopped';

            html += '<div style="padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid ' + statusColor + ';">';
            html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">';
            html += '<div style="flex: 1;">';
            html += '<strong style="font-size: 14px;">' + ctx.name + '</strong>';
            html += '<span style="margin-left: 8px; font-size: 11px; padding: 2px 6px; background: ' + statusColor + '; color: white; border-radius: 3px;">' + statusText + '</span>';
            html += '<div style="font-size: 11px; color: #666; margin-top: 3px;">Connections: ' + (ctx.connectionCount || 0) + '</div>';
            html += '</div>';
            html += '</div>';

            html += '<div style="display: flex; gap: 5px; flex-wrap: wrap;">';

            // Show Connect or Disconnect button based on subscription state
            var isSubscribed = window.__subscribedContexts && window.__subscribedContexts.has(ctx.name);
            if (isSubscribed) {
              html += '<button onclick="unsubscribeFromContext(\'' + ctx.name + '\')" style="background: #6c757d; padding: 4px 8px; font-size: 11px;">Disconnect</button>';
            } else {
              html += '<button onclick="subscribeToContext(\'' + ctx.name + '\')" style="background: #007bff; padding: 4px 8px; font-size: 11px;">Connect</button>';
            }

            if (ctx.isActive) {
              html += '<button onclick="stopContext(\'' + ctx.name + '\')" style="background: #ffc107; color: #000; padding: 4px 8px; font-size: 11px;">Stop</button>';
            } else {
              html += '<button onclick="startContext(\'' + ctx.name + '\')" style="background: #28a745; padding: 4px 8px; font-size: 11px;">Start</button>';
            }

            html += '<button onclick="deleteContext(\'' + ctx.name + '\')" style="background: #dc3545; padding: 4px 8px; font-size: 11px;">Delete</button>';
            html += '</div>';
            html += '</div>';
          });

          contextList.innerHTML = html;
        })
        .catch(function(err) {
          console.error('Error fetching contexts:', err);
        });
    }

    function subscribeToContext(name) {
      // Check if already subscribed
      if (window.__subscribedContexts && window.__subscribedContexts.has(name)) {
        console.log('Already subscribed to:', name);
        return;
      }

      var conn = window.__srConn;
      if (conn && conn.state === 'Connected') {
        // Add to subscription tracking immediately so button changes right away
        if (!window.__subscribedContexts) {
          window.__subscribedContexts = new Set();
        }
        window.__subscribedContexts.add(name);
        refreshContextList(); // Update button immediately

        conn.invoke('SubscribeToContext', name)
          .then(function() {
            console.log('Subscribed to:', name);
          })
          .catch(function(err) {
            console.error('Subscribe error:', err);
            // Remove from set if subscription failed
            if (window.__subscribedContexts) {
              window.__subscribedContexts.delete(name);
            }
            refreshContextList(); // Restore button state
            alert('Failed to subscribe: ' + err.message);
          });
      } else {
        alert('SignalR not connected. Connection state: ' + (conn ? conn.state : 'no connection'));
      }
    }

    function unsubscribeFromContext(name) {
      var conn = window.__srConn;
      if (conn && conn.state === 'Connected') {
        // Remove from subscription tracking immediately so button changes right away
        if (window.__subscribedContexts) {
          window.__subscribedContexts.delete(name);
        }
        refreshContextList(); // Update button immediately

        conn.invoke('UnsubscribeFromContext', name)
          .then(function() {
            console.log('Unsubscribed from:', name);
          })
          .catch(function(err) {
            console.error('Unsubscribe error:', err);
            // Re-add to set if unsubscribe failed
            if (!window.__subscribedContexts) {
              window.__subscribedContexts = new Set();
            }
            window.__subscribedContexts.add(name);
            refreshContextList(); // Restore button state
          });
      }
    }

    function startContext(name) {
      fetch('/api/mock/contexts/' + name + '/start', { method: 'POST' })
        .then(function(response) {
          if (response.ok) {
            refreshContextList();
          }
        });
    }

    function stopContext(name) {
      fetch('/api/mock/contexts/' + name + '/stop', { method: 'POST' })
        .then(function(response) {
          if (response.ok) {
            refreshContextList();
          }
        });
    }

    function deleteContext(name) {
      if (confirm('Are you sure you want to delete context "' + name + '"?')) {
        fetch('/api/mock/contexts/' + name, { method: 'DELETE' })
          .then(function(response) {
            if (response.ok) {
              refreshContextList();
            }
          });
      }
    }

    // Initial load
    setTimeout(refreshContextList, 500);
    </script>
</body>
</html>
