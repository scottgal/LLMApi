@page
@model LLMApi.Pages.IndexModel

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLMock API - Dynamic Context Demo</title>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .data-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }

        .timestamp {
            color: #666;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>LLMock API - Dynamic Context Demo</h1>
    <p class="subtitle">Create custom SignalR contexts with plain English descriptions</p>

    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px;">
        <a href="/" style="color: white; background: #007bff; text-decoration: none; padding: 8px 16px; border-radius: 4px;">SignalR Demo</a>
        <a href="/Streaming" style="color: #007bff; text-decoration: none; padding: 8px 16px; border-radius: 4px; transition: background 0.2s;">SSE Streaming Demo</a>
    </div>

    <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
        <h3 style="margin-top: 0;">How It Works</h3>
        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
            <li><strong>Enter a context name</strong> - A unique identifier for your data stream (e.g., "weather", "stocks", "sensors")</li>
            <li><strong>Describe what you want</strong> - Use plain English to describe the data structure you need</li>
            <li><strong>Click Create & Subscribe</strong> - The LLM generates appropriate JSON schema and starts streaming data</li>
            <li><strong>Watch live updates</strong> - New data appears every 5 seconds in real-time!</li>
        </ol>

        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: 500; color: #007bff;">View Example Descriptions</summary>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <h4 style="margin-top: 0; font-size: 14px;">IoT Sensors</h4>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                    "Temperature sensors with device ID, current temperature in Celsius, battery percentage, and last reading timestamp"
                </p>

                <h4 style="margin-top: 15px; font-size: 14px;">Stock Market</h4>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                    "Real-time stock prices with ticker symbol, current price, daily change percentage, trading volume, and market cap"
                </p>

                <h4 style="margin-top: 15px; font-size: 14px;">E-commerce Orders</h4>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                    "Recent orders with order ID, customer name, order total, status (pending/shipped/delivered), and items array containing SKU and quantity"
                </p>

                <h4 style="margin-top: 15px; font-size: 14px;">Server Metrics</h4>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                    "Server monitoring data with hostname, CPU usage percentage, memory usage in GB, disk space available, and active connections count"
                </p>

                <h4 style="margin-top: 15px; font-size: 14px;">Gaming Leaderboard</h4>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                    "Gaming leaderboard entries with player name, score, rank, level, country code, and online status"
                </p>
            </div>
        </details>

        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: 500; color: #007bff;">View API Documentation</summary>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">
                <h4 style="margin-top: 0;">Management API Endpoints</h4>

                <p><strong>POST /api/mock/contexts</strong> - Create new context</p>
                <pre style="background: #fff; padding: 10px; border-radius: 3px; overflow-x: auto;">
{
  "name": "weather",
  "description": "Weather data with temp, condition, humidity"
}</pre>

                <p><strong>GET /api/mock/contexts</strong> - List all contexts</p>
                <p><strong>GET /api/mock/contexts/{name}</strong> - Get specific context</p>
                <p><strong>DELETE /api/mock/contexts/{name}</strong> - Delete context</p>

                <h4 style="margin-top: 15px;">SignalR Hub</h4>
                <p><strong>Hub URL:</strong> /hub/mock</p>
                <p><strong>Methods:</strong></p>
                <ul style="margin: 5px 0;">
                    <li><code>SubscribeToContext(contextName)</code> - Start receiving data</li>
                    <li><code>UnsubscribeFromContext(contextName)</code> - Stop receiving data</li>
                </ul>
                <p><strong>Events:</strong></p>
                <ul style="margin: 5px 0;">
                    <li><code>DataUpdate</code> - Receives generated data</li>
                    <li><code>Subscribed</code> - Subscription confirmation</li>
                    <li><code>Unsubscribed</code> - Unsubscription confirmation</li>
                </ul>
            </div>
        </details>

        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: 500; color: #007bff;">View JavaScript Integration Example</summary>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <pre style="background: #fff; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px;">
<code>// Connect to SignalR hub
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/hub/mock")
    .withAutomaticReconnect()
    .build();

// Listen for data updates
connection.on("DataUpdate", (message) => {
    console.log(`Context: ${message.context}`);
    console.log(`Data:`, message.data);
    console.log(`Timestamp: ${message.timestamp}`);
});

// Start connection
await connection.start();

// Create a new context
const response = await fetch("/api/mock/contexts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
        name: "mydata",
        description: "Your data description here"
    })
});

// Subscribe to receive updates
await connection.invoke("SubscribeToContext", "mydata");

// Unsubscribe when done
await connection.invoke("UnsubscribeFromContext", "mydata");</code></pre>
            </div>
        </details>
    </div>

    <div class="container">
        <div class="card">
            <h2>Create Context</h2>
            <form id="contextForm">
                <div class="form-group">
                    <label for="contextName">Context Name *</label>
                    <input type="text" id="contextName" name="name" required
                           placeholder="e.g., mydata, sensors, stocks" />
                    <p class="help-text">Used to identify this SignalR context</p>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" required
                              placeholder="Describe what data you want in plain English&#10;&#10;Example: I want stock market data with symbol, price, change percentage, and trading volume"></textarea>
                    <p class="help-text">The LLM will generate appropriate JSON schema from this</p>
                </div>

                <button type="submit">Create & Subscribe</button>

                <div id="formStatus" class="status"></div>
            </form>
        </div>

        <div class="card">
            <h2>
                Live Data
                <span id="connectionStatus" class="connection-status disconnected">Disconnected</span>
            </h2>
            <div id="currentContext" style="margin-bottom: 10px; color: #666;">
                No context selected
            </div>
            <div id="dataDisplay" class="data-display">
                <p style="color: #999;">Create a context to start receiving data...</p>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentContextName = null;

        // Initialize SignalR connection
        async function initSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/hub/mock")
                .withAutomaticReconnect()
                .build();

            connection.on("DataUpdate", (message) => {
                displayData(message);
            });

            connection.on("Subscribed", (message) => {
                console.log("Subscribed:", message);
            });

            connection.onclose(() => {
                updateConnectionStatus(false);
            });

            connection.onreconnecting(() => {
                updateConnectionStatus(false);
            });

            connection.onreconnected(() => {
                updateConnectionStatus(true);
                if (currentContextName) {
                    connection.invoke("SubscribeToContext", currentContextName);
                }
            });

            try {
                await connection.start();
                updateConnectionStatus(true);
                console.log("SignalR connected");
            } catch (err) {
                console.error("SignalR connection error:", err);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById("connectionStatus");
            statusEl.textContent = connected ? "Connected" : "Disconnected";
            statusEl.className = "connection-status " + (connected ? "connected" : "disconnected");
        }

        function displayData(message) {
            const display = document.getElementById("dataDisplay");
            const timestamp = new Date(message.timestamp).toLocaleTimeString();

            const item = document.createElement("div");
            item.className = "data-item";
            item.innerHTML = `
                <div class="timestamp">${timestamp} - ${message.context}</div>
                <pre>${JSON.stringify(message.data, null, 2)}</pre>
            `;

            display.insertBefore(item, display.firstChild);

            // Keep only last 10 items
            while (display.children.length > 10) {
                display.removeChild(display.lastChild);
            }
        }

        function showStatus(message, isError = false) {
            const status = document.getElementById("formStatus");
            status.textContent = message;
            status.className = "status show " + (isError ? "error" : "success");

            setTimeout(() => {
                status.classList.remove("show");
            }, 5000);
        }

        // Handle form submission
        document.getElementById("contextForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("contextName").value.trim();
            const description = document.getElementById("description").value.trim();

            if (!name || !description) {
                showStatus("Please fill in all fields", true);
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = "Creating...";

            try {
                // Create context
                const response = await fetch("/api/mock/contexts", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        method: "GET",
                        path: `/${name}`
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(`Context '${name}' created successfully!`);

                    // Subscribe to context
                    if (connection && connection.state === signalR.HubConnectionState.Connected) {
                        // Unsubscribe from previous context if any
                        if (currentContextName && currentContextName !== name) {
                            await connection.invoke("UnsubscribeFromContext", currentContextName);
                        }

                        await connection.invoke("SubscribeToContext", name);
                        currentContextName = name;

                        document.getElementById("currentContext").textContent =
                            `Subscribed to: ${name}`;
                        document.getElementById("dataDisplay").innerHTML =
                            '<p style="color: #999;">Waiting for data...</p>';
                    }

                    // Reset form
                    e.target.reset();
                } else {
                    showStatus(result.error || "Failed to create context", true);
                }
            } catch (err) {
                console.error("Error:", err);
                showStatus("Error creating context: " + err.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Create & Subscribe";
            }
        });

        // Initialize on page load
        window.addEventListener("DOMContentLoaded", () => {
            initSignalR();
        });
    </script>
</body>
</html>
