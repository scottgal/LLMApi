@page
@model LLMApi.Pages.GrpcModel

@{
    ViewData["Title"] = "gRPC Demo";
}

@section Styles {
    <style>
        .grpc-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
            margin-bottom: 20px;
        }

        @@media (max-width: 1200px) {
            .grpc-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
            }
        }

        .panel {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
        }

        .panel h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .help-section {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .help-section h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #004085;
        }

        .help-section ul {
            margin: 0 0 0 20px;
            padding: 0;
        }

        .help-section code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-group textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-start-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-start-btn {
            padding: 12px 15px;
            background: #fff;
            border: 2px solid #e3e6ea;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }

        .quick-start-btn:hover {
            background: #e7f3ff;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.2);
        }

        .quick-start-btn strong {
            display: block;
            color: #007bff;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .quick-start-btn span {
            font-size: 0.85em;
            color: #666;
        }

        .proto-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .proto-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }

        .proto-item h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }

        .service-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .service-name {
            font-weight: 600;
            color: #007bff;
            margin-bottom: 5px;
        }

        .method-list {
            margin-left: 15px;
        }

        .method-item {
            padding: 5px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .method-signature {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #666;
        }

        .method-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
            background: #17a2b8;
            color: white;
            margin-right: 8px;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .test-result.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .test-result.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .test-result h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .json-display {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
            margin: 0;
        }

        .json-key { color: #e06c75; }
        .json-string { color: #98c379; }
        .json-number { color: #d19a66; }
        .json-boolean { color: #56b6c2; }
        .json-null { color: #c678dd; }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-loading {
            background: #ffc107;
            color: #333;
            animation: pulse-loading 1.5s ease-in-out infinite;
        }

        @@keyframes pulse-loading {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .response-meta {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .protocol-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .protocol-tab {
            flex: 1;
            padding: 10px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .protocol-tab.active {
            background: #007bff;
            color: white;
        }

        .protocol-tab:hover:not(.active) {
            background: #dee2e6;
        }

        .test-panel {
            display: none;
        }

        .test-panel.active {
            display: block;
        }
    </style>
}

<div style="max-width: 1400px; margin: 0 auto;">
    <h1>gRPC Service Mock Demo</h1>
    <p class="lead">Upload .proto files and test gRPC services with LLM-powered mock responses</p>

    <div style="background: #e7f3ff; padding: 12px 20px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #007bff;">
        <p style="margin: 0; color: #004085; font-size: 0.9em;">
            <strong>Quick Start:</strong> Upload a .proto file or use a quick-start example → View services → Test methods with JSON or binary Protobuf → See LLM-generated mock data
        </p>
    </div>

    <!-- Four Equal Quarters Layout -->
    <div class="grpc-container">
        <!-- Top Left: Upload Proto -->
        <div class="panel">
            <h2>Upload Proto File</h2>

            <div class="quick-start-buttons">
                <div class="quick-start-btn" onclick="loadGreeterExample()">
                    <strong>Greeter Service</strong>
                    <span>Simple hello world</span>
                </div>
                <div class="quick-start-btn" onclick="loadUserServiceExample()">
                    <strong>User Service</strong>
                    <span>CRUD operations</span>
                </div>
                <div class="quick-start-btn" onclick="loadEcommerceExample()">
                    <strong>E-commerce</strong>
                    <span>Products & orders</span>
                </div>
                <div class="quick-start-btn" onclick="loadWeatherExample()">
                    <strong>Weather API</strong>
                    <span>Forecast data</span>
                </div>
            </div>

            <div class="form-group">
                <label for="protoName">Proto Name</label>
                <input type="text" id="protoName" placeholder="e.g., greeter" />
            </div>

            <div class="form-group">
                <label for="protoContent">Proto Definition</label>
                <textarea id="protoContent" rows="8" placeholder="Paste your .proto file content here..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="uploadProto()">Upload Proto</button>
                <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
            </div>

            <div id="uploadStatus"></div>
        </div>

        <!-- Top Right: Proto List Panel -->
        <div class="panel">
            <h2>Uploaded Proto Files</h2>

            <div id="protoList" class="proto-list">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>No proto files uploaded yet</p>
                    <p>Use quick-start examples or upload your own</p>
                </div>
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-success btn-sm" onclick="refreshProtoList()">Refresh List</button>
            </div>
        </div>

        <!-- Bottom Left: Test Input -->
        <div class="panel">
            <h2>Test gRPC Methods</h2>

            <div class="protocol-tabs">
                <button class="protocol-tab active" onclick="switchProtocol('json')">
                    JSON (Easy Testing)
                </button>
                <button class="protocol-tab" onclick="switchProtocol('binary')">
                    Binary Protobuf
                </button>
            </div>

            <!-- JSON Test Panel -->
            <div id="jsonTestPanel" class="test-panel active">
                <div class="form-group">
                    <label for="jsonServiceName">Service Name</label>
                    <input type="text" id="jsonServiceName" placeholder="e.g., Greeter" />
                </div>

                <div class="form-group">
                    <label for="jsonMethodName">Method Name</label>
                    <input type="text" id="jsonMethodName" placeholder="e.g., SayHello" />
                </div>

                <div class="form-group">
                    <label for="jsonRequest">Request JSON</label>
                    <textarea id="jsonRequest" rows="8" placeholder='{"name": "World"}'></textarea>
                </div>

                <button class="btn btn-primary" onclick="testJsonMethod()">Call Method (JSON)</button>
            </div>

            <!-- Binary Test Panel -->
            <div id="binaryTestPanel" class="test-panel">
                <div class="form-group">
                    <label for="binaryServiceName">Service Name</label>
                    <input type="text" id="binaryServiceName" placeholder="e.g., Greeter" />
                </div>

                <div class="form-group">
                    <label for="binaryMethodName">Method Name</label>
                    <input type="text" id="binaryMethodName" placeholder="e.g., SayHello" />
                </div>

                <div class="form-group">
                    <label for="binaryRequest">Request JSON (converted to binary)</label>
                    <textarea id="binaryRequest" rows="8" placeholder='{"name": "World"}'></textarea>
                </div>

                <button class="btn btn-primary" onclick="testBinaryMethod()">Call Method (Binary)</button>
            </div>
        </div>

        <!-- Bottom Right: Test Results -->
        <div class="panel">
            <h2>Response</h2>
            <div id="testResult" style="min-height: 200px;">
                <div class="empty-state">
                    <p>Test results will appear here</p>
                    <p>Call a gRPC method to see the LLM-generated response</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentProtocol = 'json';

        // Example proto files
        const examples = {
            greeter: {
                name: 'greeter',
                content: `syntax = "proto3";

service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply);
  rpc SayGoodbye (GoodbyeRequest) returns (GoodbyeReply);
}

message HelloRequest {
  string name = 1;
  int32 age = 2;
}

message HelloReply {
  string message = 1;
  int32 request_id = 2;
  string timestamp = 3;
}

message GoodbyeRequest {
  string name = 1;
}

message GoodbyeReply {
  string message = 1;
  bool see_you_later = 2;
}`
            },
            userService: {
                name: 'users',
                content: `syntax = "proto3";

service UserService {
  rpc GetUser (GetUserRequest) returns (User);
  rpc CreateUser (CreateUserRequest) returns (User);
  rpc UpdateUser (UpdateUserRequest) returns (User);
  rpc DeleteUser (DeleteUserRequest) returns (DeleteUserResponse);
  rpc ListUsers (ListUsersRequest) returns (ListUsersResponse);
}

message User {
  string id = 1;
  string name = 2;
  string email = 3;
  string role = 4;
  int64 created_at = 5;
}

message GetUserRequest {
  string id = 1;
}

message CreateUserRequest {
  string name = 1;
  string email = 2;
  string role = 3;
}

message UpdateUserRequest {
  string id = 1;
  string name = 2;
  string email = 3;
}

message DeleteUserRequest {
  string id = 1;
}

message DeleteUserResponse {
  bool success = 1;
  string message = 2;
}

message ListUsersRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message ListUsersResponse {
  repeated User users = 1;
  int32 total_count = 2;
}`
            },
            ecommerce: {
                name: 'ecommerce',
                content: `syntax = "proto3";

service ProductService {
  rpc GetProduct (GetProductRequest) returns (Product);
  rpc ListProducts (ListProductsRequest) returns (ListProductsResponse);
}

service OrderService {
  rpc CreateOrder (CreateOrderRequest) returns (Order);
  rpc GetOrder (GetOrderRequest) returns (Order);
}

message Product {
  string id = 1;
  string name = 2;
  string description = 3;
  double price = 4;
  int32 stock = 5;
  string category = 6;
}

message GetProductRequest {
  string id = 1;
}

message ListProductsRequest {
  string category = 1;
  int32 limit = 2;
}

message ListProductsResponse {
  repeated Product products = 1;
}

message Order {
  string id = 1;
  string customer_id = 2;
  repeated OrderItem items = 3;
  double total = 4;
  string status = 5;
  int64 created_at = 6;
}

message OrderItem {
  string product_id = 1;
  int32 quantity = 2;
  double price = 3;
}

message CreateOrderRequest {
  string customer_id = 1;
  repeated OrderItem items = 2;
}

message GetOrderRequest {
  string id = 1;
}`
            },
            weather: {
                name: 'weather',
                content: `syntax = "proto3";

service WeatherService {
  rpc GetCurrentWeather (WeatherRequest) returns (WeatherResponse);
  rpc GetForecast (ForecastRequest) returns (ForecastResponse);
}

message WeatherRequest {
  string city = 1;
  string country_code = 2;
}

message WeatherResponse {
  string city = 1;
  double temperature = 2;
  string condition = 3;
  int32 humidity = 4;
  double wind_speed = 5;
  int64 timestamp = 6;
}

message ForecastRequest {
  string city = 1;
  int32 days = 2;
}

message ForecastResponse {
  string city = 1;
  repeated DailyForecast forecast = 2;
}

message DailyForecast {
  string date = 1;
  double temp_high = 2;
  double temp_low = 3;
  string condition = 4;
  int32 precipitation_chance = 5;
}`
            }
        };

        function loadGreeterExample() {
            loadExample(examples.greeter);
        }

        function loadUserServiceExample() {
            loadExample(examples.userService);
        }

        function loadEcommerceExample() {
            loadExample(examples.ecommerce);
        }

        function loadWeatherExample() {
            loadExample(examples.weather);
        }

        function loadExample(example) {
            document.getElementById('protoName').value = example.name;
            document.getElementById('protoContent').value = example.content;
        }

        function clearForm() {
            document.getElementById('protoName').value = '';
            document.getElementById('protoContent').value = '';
            document.getElementById('uploadStatus').innerHTML = '';
        }

        function switchProtocol(protocol) {
            currentProtocol = protocol;

            // Update tabs
            document.querySelectorAll('.protocol-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update panels
            document.getElementById('jsonTestPanel').classList.toggle('active', protocol === 'json');
            document.getElementById('binaryTestPanel').classList.toggle('active', protocol === 'binary');

            // Clear test results when switching
            document.getElementById('testResult').innerHTML = '';
        }

        async function uploadProto() {
            const name = document.getElementById('protoName').value.trim();
            const content = document.getElementById('protoContent').value.trim();

            if (!name || !content) {
                showStatus('uploadStatus', 'error', 'Please provide both name and proto content');
                return;
            }

            showStatus('uploadStatus', 'loading', 'Uploading proto file...');

            try {
                // Send as plain text with filename in URL
                const response = await fetch(`/api/grpc-protos?name=${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: content
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('uploadStatus', 'success', `Proto "${name}" uploaded successfully!`);
                    clearForm();
                    await refreshProtoList();
                } else {
                    // Read response as text first, then try to parse as JSON
                    const responseText = await response.text();
                    let errorMsg = 'Upload failed';

                    if (responseText) {
                        try {
                            const error = JSON.parse(responseText);
                            errorMsg = error.error || error.title || error.detail || responseText;
                        } catch {
                            errorMsg = responseText;
                        }
                    } else {
                        errorMsg = `HTTP ${response.status}`;
                    }
                    showStatus('uploadStatus', 'error', errorMsg);
                }
            } catch (err) {
                showStatus('uploadStatus', 'error', `Error: ${err.message}`);
            }
        }

        async function refreshProtoList() {
            const listEl = document.getElementById('protoList');
            listEl.innerHTML = '<div class="status-badge status-loading">Loading...</div>';

            try {
                const response = await fetch('/api/grpc-protos');
                if (!response.ok) throw new Error('Failed to fetch proto files');

                const data = await response.json();

                if (!data.protos || data.protos.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>No proto files uploaded yet</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const proto of data.protos) {
                    html += `
                        <div class="proto-item">
                            <h3>${proto.name}</h3>
                            ${proto.services.map(service => `
                                <div class="service-item">
                                    <div class="service-name">${service.name}</div>
                                    <div class="method-list">
                                        ${service.methods.map(method => `
                                            <div class="method-item">
                                                <div>
                                                    <span class="method-type">RPC</span>
                                                    <span class="method-signature">${method.name}(${method.inputType}) → ${method.outputType}</span>
                                                </div>
                                                <button class="btn btn-primary btn-sm" onclick="selectMethod('${service.name}', '${method.name}', '${method.inputType}')">
                                                    Test
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                            <div class="button-group" style="margin-top: 10px;">
                                <button class="btn btn-danger btn-sm" onclick="deleteProto('${proto.name}')">Delete</button>
                            </div>
                        </div>
                    `;
                }
                listEl.innerHTML = html;
            } catch (err) {
                listEl.innerHTML = `<div class="test-result error">Error: ${err.message}</div>`;
            }
        }

        function selectMethod(serviceName, methodName, inputType) {
            // Populate both JSON and binary forms
            document.getElementById('jsonServiceName').value = serviceName;
            document.getElementById('jsonMethodName').value = methodName;
            document.getElementById('binaryServiceName').value = serviceName;
            document.getElementById('binaryMethodName').value = methodName;

            // Clear previous results
            document.getElementById('testResult').innerHTML = '';

            // Generate sample request based on common input types
            const sampleRequests = {
                'HelloRequest': '{"name": "World", "age": 25}',
                'GoodbyeRequest': '{"name": "World"}',
                'GetUserRequest': '{"id": "user-123"}',
                'CreateUserRequest': '{"name": "Alice", "email": "alice@example.com", "role": "user"}',
                'WeatherRequest': '{"city": "London", "country_code": "GB"}',
                'GetProductRequest': '{"id": "prod-123"}',
                'ListProductsRequest': '{"category": "electronics", "limit": 10}'
            };

            const sampleRequest = sampleRequests[inputType] || '{}';
            document.getElementById('jsonRequest').value = sampleRequest;
            document.getElementById('binaryRequest').value = sampleRequest;
        }

        async function testJsonMethod() {
            const serviceName = document.getElementById('jsonServiceName').value.trim();
            const methodName = document.getElementById('jsonMethodName').value.trim();
            const requestText = document.getElementById('jsonRequest').value.trim();

            if (!serviceName || !methodName) {
                showTestResult('error', 'Please specify service and method names');
                return;
            }

            let requestJson;
            try {
                requestJson = requestText ? JSON.parse(requestText) : {};
            } catch (err) {
                showTestResult('error', `Invalid JSON: ${err.message}`);
                return;
            }

            showTestResult('loading', 'Calling gRPC method via JSON...');

            try {
                const response = await fetch(`/api/grpc/${serviceName}/${methodName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestJson)
                });

                const responseText = await response.text();

                if (response.ok) {
                    const responseJson = JSON.parse(responseText);
                    showTestResult('success', 'Success', responseJson, 'JSON over HTTP');
                } else {
                    showTestResult('error', `Error ${response.status}`, responseText);
                }
            } catch (err) {
                showTestResult('error', 'Request failed', err.message);
            }
        }

        async function testBinaryMethod() {
            const serviceName = document.getElementById('binaryServiceName').value.trim();
            const methodName = document.getElementById('binaryMethodName').value.trim();
            const requestText = document.getElementById('binaryRequest').value.trim();

            if (!serviceName || !methodName) {
                showTestResult('error', 'Please specify service and method names');
                return;
            }

            let requestJson;
            try {
                requestJson = requestText ? JSON.parse(requestText) : {};
            } catch (err) {
                showTestResult('error', `Invalid JSON: ${err.message}`);
                return;
            }

            showTestResult('loading', 'Calling gRPC method via binary Protobuf...');

            try {
                // For demo purposes, we'll send JSON and get binary back
                // In a real scenario, you'd encode to binary first
                const response = await fetch(`/api/grpc/proto/${serviceName}/${methodName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestJson)
                });

                if (response.ok) {
                    // Try to parse as JSON (our implementation returns JSON for now)
                    const responseText = await response.text();
                    try {
                        const responseJson = JSON.parse(responseText);
                        showTestResult('success', 'Success (Binary Endpoint)', responseJson, 'Binary Protobuf');
                    } catch {
                        showTestResult('success', 'Success (Binary Response)', responseText, 'Binary Protobuf');
                    }
                } else {
                    const errorText = await response.text();
                    showTestResult('error', `Error ${response.status}`, errorText);
                }
            } catch (err) {
                showTestResult('error', 'Request failed', err.message);
            }
        }

        async function deleteProto(name) {
            if (!confirm(`Delete proto file "${name}"?`)) return;

            try {
                const response = await fetch(`/api/grpc-protos/${name}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await refreshProtoList();
                } else {
                    const error = await response.json();
                    alert(`Delete failed: ${error.error || 'Unknown error'}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            const statusClass = type === 'loading' ? 'status-badge status-loading' :
                              type === 'success' ? 'test-result success' :
                              'test-result error';

            el.innerHTML = `<div class="${statusClass}">${message}</div>`;
        }

        function showTestResult(type, title, content, protocol) {
            const resultEl = document.getElementById('testResult');

            if (type === 'loading') {
                resultEl.innerHTML = `
                    <div class="test-result">
                        <span class="status-badge status-loading">${title}</span>
                    </div>
                `;
                return;
            }

            const className = type === 'success' ? 'test-result success' : 'test-result error';

            let contentHtml = '';
            if (typeof content === 'object') {
                const jsonStr = JSON.stringify(content, null, 2);
                contentHtml = `<pre class="json-display">${syntaxHighlight(jsonStr)}</pre>`;
            } else {
                contentHtml = `<pre class="json-display">${escapeHtml(content)}</pre>`;
            }

            const meta = protocol ? `<div class="response-meta">Protocol: <strong>${protocol}</strong></div>` : '';

            resultEl.innerHTML = `
                <div class="${className}">
                    <h4>${title}</h4>
                    ${meta}
                    ${contentHtml}
                </div>
            `;
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load proto list on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshProtoList();
        });
    </script>
}
