@page
@model LLMApi.Pages.StreamingModel

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLMock API - SSE Streaming Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }

        .nav-links {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: #007bff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nav-links a:hover {
            background: #f0f0f0;
        }

        .nav-links a.active {
            background: #007bff;
            color: white;
        }

        .docs-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
        }

        button:hover {
            background: #218838;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.stop {
            background: #dc3545;
        }

        button.stop:hover {
            background: #c82333;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stream-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .chunk-item {
            background: white;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #28a745;
            border-radius: 3px;
            word-break: break-all;
        }

        .chunk-item.done {
            border-left-color: #007bff;
            background: #e7f3ff;
        }

        .timestamp {
            color: #666;
            font-size: 11px;
            margin-bottom: 3px;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.streaming {
            background: #fff3cd;
            color: #856404;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 5px 0;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        details {
            margin-top: 15px;
        }

        summary {
            cursor: pointer;
            font-weight: 500;
            color: #007bff;
            padding: 5px 0;
        }

        .example-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .stat-item {
            flex: 1;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>LLMock API - SSE Streaming Demo</h1>
    <p class="subtitle">Real-time Server-Sent Events (SSE) streaming with progressive JSON generation</p>

    <div class="nav-links">
        <a href="/">SignalR Demo</a>
        <a href="/Streaming" class="active">SSE Streaming Demo</a>
    </div>

    <div class="docs-section">
        <h3 style="margin-top: 0;">How Server-Sent Events (SSE) Work</h3>
        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
            <li><strong>Configure your request</strong> - Choose HTTP method, path, and optional JSON shape</li>
            <li><strong>Click "Start Streaming"</strong> - Opens EventSource connection to `/api/mock/stream/{path}`</li>
            <li><strong>Watch data arrive in chunks</strong> - LLM generates JSON progressively, sending each token as it's created</li>
            <li><strong>Final event contains complete JSON</strong> - When done=true, you get the full assembled response</li>
        </ol>

        <details>
            <summary>View Example Shapes</summary>
            <div class="example-box">
                <h4 style="margin-top: 0; font-size: 14px;">Simple User Object</h4>
                <pre>{"id":0,"name":"string","email":"string","active":true}</pre>

                <h4 style="margin-top: 15px; font-size: 14px;">Product Catalog</h4>
                <pre>{"products":[{"sku":"string","name":"string","price":0.0,"inStock":true}]}</pre>

                <h4 style="margin-top: 15px; font-size: 14px;">Nested Order</h4>
                <pre>{"orderId":"string","customer":{"id":"string","name":"string"},"items":[{"sku":"string","qty":0}],"total":0.0}</pre>

                <h4 style="margin-top: 15px; font-size: 14px;">JSON Schema</h4>
                <pre>{"type":"object","properties":{"temperature":{"type":"number"},"condition":{"type":"string"}},"required":["temperature"]}</pre>
            </div>
        </details>

        <details>
            <summary>View EventSource Code Example</summary>
            <div class="example-box">
                <pre style="background: #fff; padding: 10px; border-radius: 3px;"><code>// Create EventSource connection
const eventSource = new EventSource('/api/mock/stream/users?limit=5');

// Listen for messages
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.done) {
        console.log('Complete JSON:', data.content);
        eventSource.close();
    } else {
        console.log('Chunk:', data.chunk);
        // Append chunk to display
    }
};

// Handle errors
eventSource.onerror = (error) => {
    console.error('SSE Error:', error);
    eventSource.close();
};</code></pre>
            </div>
        </details>

        <details>
            <summary>View SSE Response Format</summary>
            <div class="example-box">
                <p style="margin-bottom: 10px;"><strong>Chunk Events (done=false):</strong></p>
                <pre style="background: #fff; padding: 10px; border-radius: 3px;">data: {"chunk":"{","done":false}

data: {"chunk":"\"id\"","done":false}

data: {"chunk":":","done":false}

data: {"chunk":"123","done":false}</pre>

                <p style="margin: 15px 0 10px;"><strong>Final Event (done=true):</strong></p>
                <pre style="background: #fff; padding: 10px; border-radius: 3px;">data: {"content":"{\"id\":123,\"name\":\"John\"}","done":true,"schema":"{\"id\":0,\"name\":\"string\"}"}</pre>
            </div>
        </details>
    </div>

    <div class="container">
        <div class="card">
            <h2>Stream Configuration</h2>
            <form id="streamForm">
                <div class="form-group">
                    <label for="method">HTTP Method</label>
                    <select id="method" name="method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="path">Path</label>
                    <input type="text" id="path" name="path" value="products" placeholder="e.g., users, orders, data" />
                    <p class="help-text">Will connect to: /api/mock/stream/{path}</p>
                </div>

                <div class="form-group">
                    <label for="queryString">Query String (optional)</label>
                    <input type="text" id="queryString" name="queryString" placeholder="e.g., limit=10&category=electronics" />
                    <p class="help-text">Added as: ?{queryString}</p>
                </div>

                <div class="form-group">
                    <label for="shape">JSON Shape (optional)</label>
                    <textarea id="shape" name="shape" placeholder='{"id":0,"name":"string","email":"string"}'></textarea>
                    <p class="help-text">Leave empty for free-form generation, or specify exact structure</p>
                </div>

                <button type="button" id="startBtn">Start Streaming</button>
                <button type="button" id="stopBtn" class="stop" disabled>Stop Streaming</button>

                <div id="formStatus" class="status"></div>
            </form>
        </div>

        <div class="card">
            <h2>
                Live Stream
                <span id="connectionStatus" class="connection-status disconnected">Disconnected</span>
            </h2>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Chunks</div>
                    <div class="stat-value" id="chunkCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value" id="duration">0s</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Size</div>
                    <div class="stat-value" id="dataSize">0</div>
                </div>
            </div>

            <div id="streamDisplay" class="stream-display">
                <p style="color: #999;">Click "Start Streaming" to begin...</p>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let chunkCount = 0;
        let startTime = null;
        let durationInterval = null;
        let totalSize = 0;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const streamDisplay = document.getElementById('streamDisplay');
        const statusEl = document.getElementById('formStatus');
        const connectionStatus = document.getElementById('connectionStatus');

        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
            connectionStatus.className = `connection-status ${status.toLowerCase().replace(' ', '-')}`;
        }

        function updateStats() {
            document.getElementById('chunkCount').textContent = chunkCount;
            document.getElementById('dataSize').textContent = formatBytes(totalSize);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i)) + ' ' + sizes[i];
        }

        function startDurationTimer() {
            let seconds = 0;
            durationInterval = setInterval(() => {
                seconds++;
                document.getElementById('duration').textContent = seconds + 's';
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        function showStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.className = `status show ${isError ? 'error' : 'success'}`;
            setTimeout(() => statusEl.classList.remove('show'), 5000);
        }

        function displayChunk(chunk, isDone = false) {
            const item = document.createElement('div');
            item.className = `chunk-item ${isDone ? 'done' : ''}`;

            const timestamp = new Date().toLocaleTimeString();
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'timestamp';
            timestampDiv.textContent = timestamp;

            const contentDiv = document.createElement('pre');
            contentDiv.textContent = chunk;

            item.appendChild(timestampDiv);
            item.appendChild(contentDiv);

            if (streamDisplay.firstChild && streamDisplay.firstChild.tagName === 'P') {
                streamDisplay.innerHTML = '';
            }

            streamDisplay.insertBefore(item, streamDisplay.firstChild);

            // Keep only last 100 chunks
            while (streamDisplay.children.length > 100) {
                streamDisplay.removeChild(streamDisplay.lastChild);
            }
        }

        startBtn.addEventListener('click', () => {
            if (eventSource) {
                showStatus('Stream already running', true);
                return;
            }

            const method = document.getElementById('method').value;
            const path = document.getElementById('path').value.trim();
            const queryString = document.getElementById('queryString').value.trim();
            const shape = document.getElementById('shape').value.trim();

            if (!path) {
                showStatus('Please enter a path', true);
                return;
            }

            // Reset stats
            chunkCount = 0;
            totalSize = 0;
            updateStats();
            streamDisplay.innerHTML = '';

            // Build URL
            let url = `/api/mock/stream/${path}`;
            const params = new URLSearchParams();

            if (queryString) {
                queryString.split('&').forEach(pair => {
                    const [key, value] = pair.split('=');
                    if (key) params.append(key, value || '');
                });
            }

            if (shape) {
                params.append('shape', shape);
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            // Start EventSource
            try {
                eventSource = new EventSource(url);
                startTime = Date.now();
                startDurationTimer();

                updateConnectionStatus('Streaming');
                startBtn.disabled = true;
                stopBtn.disabled = false;

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.done) {
                            displayChunk(`âœ“ COMPLETE\n${data.content}`, true);
                            updateConnectionStatus('Complete');
                            stopStream();
                            showStatus('Stream completed successfully');
                        } else if (data.chunk) {
                            chunkCount++;
                            totalSize += data.chunk.length;
                            updateStats();
                            displayChunk(data.chunk);
                        }
                    } catch (err) {
                        console.error('Parse error:', err);
                        displayChunk(`Error: ${err.message}`, true);
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    showStatus('Stream error occurred', true);
                    updateConnectionStatus('Error');
                    stopStream();
                };

            } catch (err) {
                showStatus(`Failed to start stream: ${err.message}`, true);
                updateConnectionStatus('Disconnected');
            }
        });

        stopBtn.addEventListener('click', () => {
            stopStream();
            showStatus('Stream stopped');
        });

        function stopStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            stopDurationTimer();
            updateConnectionStatus('Disconnected');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    </script>
</body>
</html>
