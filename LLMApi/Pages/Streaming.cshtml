@page
@model LLMApi.Pages.StreamingModel

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLMock API - SSE Streaming Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }

        .nav-links {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: #007bff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nav-links a:hover {
            background: #f0f0f0;
        }

        .nav-links a.active {
            background: #007bff;
            color: white;
        }

        .docs-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            transition: all 0.2s;
        }

        button:hover {
            background: #218838;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button.stop {
            background: #dc3545;
        }

        button.stop:hover {
            background: #c82333;
        }

        button.streaming {
            background: #ffc107;
            color: #000;
            cursor: wait;
        }

        button.streaming:hover {
            background: #ffc107;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stream-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .chunk-item {
            background: white;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #28a745;
            border-radius: 3px;
            word-break: break-all;
        }

        .chunk-item.done {
            border-left-color: #007bff;
            background: #e7f3ff;
        }

        .timestamp {
            color: #666;
            font-size: 11px;
            margin-bottom: 3px;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.streaming {
            background: #fff3cd;
            color: #856404;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 5px 0;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* JSON syntax highlighting */
        .json-key {
            color: #e06c75;
        }

        .json-string {
            color: #98c379;
        }

        .json-number {
            color: #d19a66;
        }

        .json-boolean {
            color: #56b6c2;
        }

        .json-null {
            color: #c678dd;
        }

        .chunk-item.done pre {
            background: #282c34;
            color: #abb2bf;
            padding: 12px;
            border-radius: 4px;
        }

        details {
            margin-top: 15px;
        }

        summary {
            cursor: pointer;
            font-weight: 500;
            color: #007bff;
            padding: 5px 0;
        }

        .example-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .stat-item {
            flex: 1;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>LLMock API - SSE Streaming Demo</h1>
    <p class="subtitle">Real-time Server-Sent Events (SSE) streaming with three distinct modes</p>

    <div class="nav-links">
        <a href="/">SignalR Demo</a>
        <a href="/Streaming" class="active">SSE Streaming Demo</a>
    </div>

    <div class="docs-section">
        <h3 style="margin-top: 0;">Three SSE Streaming Modes</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0;">
            <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; border: 2px solid #4a90e2;">
                <h4 style="margin: 0 0 8px 0; color: #2c5aa0;">ðŸ¤– LlmTokens</h4>
                <p style="margin: 0; font-size: 13px; color: #555;">Token-by-token streaming for AI chat interfaces. Emulates ChatGPT-style progressive text generation.</p>
            </div>
            <div style="background: #f0fff4; padding: 12px; border-radius: 6px; border: 2px solid #48bb78;">
                <h4 style="margin: 0 0 8px 0; color: #276749;">ðŸ“¦ CompleteObjects</h4>
                <p style="margin: 0; font-size: 13px; color: #555;">Complete JSON objects per event. Emulates Twitter/X API, stock tickers, real-time feeds.</p>
            </div>
            <div style="background: #fffaf0; padding: 12px; border-radius: 6px; border: 2px solid #ed8936;">
                <h4 style="margin: 0 0 8px 0; color: #7c2d12;">ðŸ“‹ ArrayItems</h4>
                <p style="margin: 0; font-size: 13px; color: #555;">Array items with metadata. Emulates paginated results, bulk exports, search results.</p>
            </div>
        </div>

        <details open>
            <summary>Quick Start Examples (Click to Stream)</summary>
            <div class="example-box">
                <h4 style="margin: 10px 0 10px 0; color: #2c5aa0;">ðŸ¤– LlmTokens Mode Examples</h4>

                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #4a90e2;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">AI Chat Message</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">Token-by-token chat response streaming</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="chat" data-mode="LlmTokens" data-shape='{"message":"Hello!"}' style="background: #4a90e2; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: #276749;">ðŸ“¦ CompleteObjects Mode Examples</h4>

                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #48bb78;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">Stock Ticker Feed</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">Real-time stock prices (like Twitter/X API)</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="stocks" data-mode="CompleteObjects" data-shape='{"ticker":"AAPL","price":150.25,"change":2.5}' style="background: #48bb78; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #48bb78;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">User Updates</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">Complete user objects per event</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="users" data-mode="CompleteObjects" data-shape='{"users":[{"id":0,"name":"string","email":"string"}]}' style="background: #48bb78; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: #7c2d12;">ðŸ“‹ ArrayItems Mode Examples</h4>

                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #ed8936;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">Bulk Customer Export</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">Paginated results with progress tracking</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="customers" data-mode="ArrayItems" data-shape='{"customers":[{"id":"string","name":"string","email":"string"}]}' style="background: #ed8936; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #ed8936;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">Search Results</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">Search results streamed with metadata</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="search" data-mode="ArrayItems" data-shape='{"results":[{"id":"string","title":"string","score":0.95}]}' style="background: #ed8936; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: #9333ea;">ðŸ”„ Continuous Mode Examples (Like SignalR)</h4>

                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #9333ea;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">Live Stock Dashboard</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">Continuous stock updates every 2 seconds</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="stocks" data-mode="CompleteObjects" data-continuous="true" data-interval="2000" data-shape='{"ticker":"AAPL","price":150.25,"change":2.5}' style="background: #9333ea; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>

                <div style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #9333ea;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 13px;">Real-Time Sensor Data</h4>
                        <p style="margin: 3px 0; font-size: 12px; color: #666;">IoT sensors streaming continuously</p>
                    </div>
                    <button type="button" class="quick-sse-btn" data-path="sensors" data-mode="ArrayItems" data-continuous="true" data-interval="3000" data-shape='{"sensors":[{"id":"string","temp":0,"humidity":0}]}' style="background: #9333ea; padding: 5px 12px; font-size: 12px; white-space: nowrap;">Stream</button>
                </div>
            </div>
        </details>

        <details>
            <summary>View More Example Shapes</summary>
            <div class="example-box">
                <h4 style="margin-top: 0; font-size: 14px;">Simple User Object</h4>
                <pre>{"id":0,"name":"string","email":"string","active":true}</pre>

                <h4 style="margin-top: 15px; font-size: 14px;">Product Catalog</h4>
                <pre>{"products":[{"sku":"string","name":"string","price":0.0,"inStock":true}]}</pre>

                <h4 style="margin-top: 15px; font-size: 14px;">Nested Order</h4>
                <pre>{"orderId":"string","customer":{"id":"string","name":"string"},"items":[{"sku":"string","qty":0}],"total":0.0}</pre>

                <h4 style="margin-top: 15px; font-size: 14px;">JSON Schema</h4>
                <pre>{"type":"object","properties":{"temperature":{"type":"number"},"condition":{"type":"string"}},"required":["temperature"]}</pre>
            </div>
        </details>

        <details>
            <summary>View EventSource Code Example</summary>
            <div class="example-box">
                <pre style="background: #fff; padding: 10px; border-radius: 3px;"><code>// Create EventSource connection
const eventSource = new EventSource('/api/mock/stream/users?limit=5');

// Listen for messages
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.done) {
        console.log('Complete JSON:', data.content);
        eventSource.close();
    } else {
        console.log('Chunk:', data.chunk);
        // Append chunk to display
    }
};

// Handle errors
eventSource.onerror = (error) => {
    console.error('SSE Error:', error);
    eventSource.close();
};</code></pre>
            </div>
        </details>

        <details>
            <summary>View SSE Response Formats (All Modes)</summary>
            <div class="example-box">
                <h4 style="margin-top: 0; font-size: 14px; color: #2c5aa0;">ðŸ¤– LlmTokens Mode Format</h4>
                <p style="margin-bottom: 10px;"><strong>Chunk Events:</strong></p>
                <pre style="background: #fff; padding: 10px; border-radius: 3px;">data: {"chunk":"{","accumulated":"{","done":false}
data: {"chunk":"\"id\"","accumulated":"{\"id\"","done":false}
data: {"chunk":"123","accumulated":"{\"id\":123","done":false}</pre>
                <p style="margin: 10px 0;"><strong>Final Event:</strong></p>
                <pre style="background: #fff; padding: 10px; border-radius: 3px;">data: {"content":"{\"id\":123,\"name\":\"John\"}","done":true}</pre>

                <h4 style="margin: 20px 0 10px; font-size: 14px; color: #276749;">ðŸ“¦ CompleteObjects Mode Format</h4>
                <pre style="background: #fff; padding: 10px; border-radius: 3px;">data: {"data":{"ticker":"AAPL","price":150.32},"index":0,"total":5,"done":false}
data: {"data":{"ticker":"AAPL","price":150.45},"index":1,"total":5,"done":false}
data: {"data":{"ticker":"AAPL","price":150.67},"index":4,"total":5,"done":true}</pre>

                <h4 style="margin: 20px 0 10px; font-size: 14px; color: #7c2d12;">ðŸ“‹ ArrayItems Mode Format</h4>
                <pre style="background: #fff; padding: 10px; border-radius: 3px;">data: {"item":{"id":"u1","name":"Alice"},"index":0,"total":100,"arrayName":"customers","hasMore":true,"done":false}
data: {"item":{"id":"u2","name":"Bob"},"index":1,"total":100,"arrayName":"customers","hasMore":true,"done":false}
data: {"item":{"id":"u100","name":"Zara"},"index":99,"total":100,"arrayName":"customers","hasMore":false,"done":true}</pre>
            </div>
        </details>
    </div>

    <div class="container">
        <div class="card">
            <h2>Stream Configuration</h2>
            <form id="streamForm">
                <div class="form-group">
                    <label for="method">HTTP Method</label>
                    <select id="method" name="method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sseMode">SSE Streaming Mode</label>
                    <select id="sseMode" name="sseMode">
                        <option value="LlmTokens">ðŸ¤– LlmTokens - Token-by-token (AI chat)</option>
                        <option value="CompleteObjects">ðŸ“¦ CompleteObjects - Full objects per event (Twitter API, stocks)</option>
                        <option value="ArrayItems">ðŸ“‹ ArrayItems - Array items with metadata (bulk exports)</option>
                    </select>
                    <p class="help-text">Choose the streaming mode that matches your use case</p>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="continuous" name="continuous" style="width: auto; margin-right: 8px;" />
                        <span>ðŸ”„ Continuous Streaming Mode (like SignalR)</span>
                    </label>
                    <p class="help-text">Keep connection open and generate new data periodically</p>
                </div>

                <div id="continuousSettings" style="display: none; margin-left: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <div class="form-group">
                        <label for="interval">Interval (milliseconds)</label>
                        <input type="number" id="interval" name="interval" value="2000" min="100" max="60000" />
                        <p class="help-text">Time between events (2000 = 2 seconds)</p>
                    </div>

                    <div class="form-group">
                        <label for="maxDuration">Max Duration (seconds)</label>
                        <input type="number" id="maxDuration" name="maxDuration" value="60" min="0" max="3600" />
                        <p class="help-text">Maximum connection duration (0 = unlimited)</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="path">Path</label>
                    <input type="text" id="path" name="path" value="products" placeholder="e.g., users, orders, data" />
                    <p class="help-text">Will connect to: /api/mock/stream/{path}</p>
                </div>

                <div class="form-group">
                    <label for="queryString">Query String (optional)</label>
                    <input type="text" id="queryString" name="queryString" placeholder="e.g., limit=10&category=electronics" />
                    <p class="help-text">Added as: ?{queryString}</p>
                </div>

                <div class="form-group">
                    <label for="shape">JSON Shape (optional)</label>
                    <textarea id="shape" name="shape" placeholder='{"id":0,"name":"string","email":"string"}'></textarea>
                    <p class="help-text">Leave empty for free-form generation, or specify exact structure</p>
                </div>

                <button type="button" id="startBtn">Start Streaming</button>
                <button type="button" id="stopBtn" class="stop" disabled>Stop Streaming</button>

                <div id="formStatus" class="status"></div>
            </form>
        </div>

        <div class="card">
            <h2>
                Live Stream
                <span id="connectionStatus" class="connection-status disconnected">Disconnected</span>
            </h2>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Chunks</div>
                    <div class="stat-value" id="chunkCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value" id="duration">0s</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Size</div>
                    <div class="stat-value" id="dataSize">0</div>
                </div>
            </div>

            <div id="streamDisplay" class="stream-display">
                <p style="color: #999;">Click "Start Streaming" to begin...</p>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let chunkCount = 0;
        let startTime = null;
        let durationInterval = null;
        let totalSize = 0;
        let activeQuickButton = null;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const streamDisplay = document.getElementById('streamDisplay');
        const statusEl = document.getElementById('formStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const continuousCheckbox = document.getElementById('continuous');
        const continuousSettings = document.getElementById('continuousSettings');

        // Show/hide continuous settings based on checkbox
        continuousCheckbox.addEventListener('change', function() {
            continuousSettings.style.display = this.checked ? 'block' : 'none';
        });

        // Disable/enable all quick-start buttons
        function setQuickButtonsEnabled(enabled) {
            document.querySelectorAll('.quick-sse-btn').forEach(btn => {
                if (enabled) {
                    btn.disabled = false;
                    btn.classList.remove('streaming');
                    btn.textContent = 'Stream';
                } else {
                    if (btn !== activeQuickButton) {
                        btn.disabled = true;
                    }
                }
            });
        }

        // Set active button state
        function setActiveQuickButton(button, isActive) {
            if (isActive) {
                activeQuickButton = button;
                button.classList.add('streaming');
                button.textContent = 'Streaming...';
                button.disabled = false; // Keep active button enabled (acts as stop)
            } else {
                if (activeQuickButton) {
                    activeQuickButton.classList.remove('streaming');
                    activeQuickButton.textContent = 'Stream';
                }
                activeQuickButton = null;
            }
        }

        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
            connectionStatus.className = `connection-status ${status.toLowerCase().replace(' ', '-')}`;
        }

        function updateStats() {
            document.getElementById('chunkCount').textContent = chunkCount;
            document.getElementById('dataSize').textContent = formatBytes(totalSize);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i)) + ' ' + sizes[i];
        }

        function startDurationTimer() {
            let seconds = 0;
            durationInterval = setInterval(() => {
                seconds++;
                document.getElementById('duration').textContent = seconds + 's';
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        function showStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.className = `status show ${isError ? 'error' : 'success'}`;
            setTimeout(() => statusEl.classList.remove('show'), 5000);
        }

        // Simple JSON syntax highlighting
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function displayChunk(chunk, isDone = false) {
            const item = document.createElement('div');
            item.className = `chunk-item ${isDone ? 'done' : ''}`;

            const timestamp = new Date().toLocaleTimeString();
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'timestamp';
            timestampDiv.textContent = timestamp;

            const contentDiv = document.createElement('pre');

            // Apply syntax highlighting for complete JSON
            if (isDone && (chunk.includes('{') || chunk.includes('['))) {
                try {
                    // Extract JSON from "âœ“ COMPLETE\n{...}" format
                    const jsonMatch = chunk.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const jsonStr = jsonMatch[0];
                        const formatted = JSON.stringify(JSON.parse(jsonStr), null, 2);
                        contentDiv.innerHTML = 'âœ“ COMPLETE\n' + syntaxHighlight(formatted);
                    } else {
                        contentDiv.textContent = chunk;
                    }
                } catch (e) {
                    contentDiv.textContent = chunk;
                }
            } else {
                contentDiv.textContent = chunk;
            }

            item.appendChild(timestampDiv);
            item.appendChild(contentDiv);

            if (streamDisplay.firstChild && streamDisplay.firstChild.tagName === 'P') {
                streamDisplay.innerHTML = '';
            }

            streamDisplay.insertBefore(item, streamDisplay.firstChild);

            // Keep only last 100 chunks
            while (streamDisplay.children.length > 100) {
                streamDisplay.removeChild(streamDisplay.lastChild);
            }
        }

        startBtn.addEventListener('click', () => {
            if (eventSource) {
                showStatus('Stream already running', true);
                return;
            }

            const method = document.getElementById('method').value;
            const path = document.getElementById('path').value.trim();
            const queryString = document.getElementById('queryString').value.trim();
            const shape = document.getElementById('shape').value.trim();
            const sseMode = document.getElementById('sseMode').value;
            const continuous = document.getElementById('continuous').checked;
            const interval = document.getElementById('interval').value;
            const maxDuration = document.getElementById('maxDuration').value;

            if (!path) {
                showStatus('Please enter a path', true);
                return;
            }

            // Reset stats
            chunkCount = 0;
            totalSize = 0;
            updateStats();
            streamDisplay.innerHTML = '';

            // Build URL
            let url = `/api/mock/stream/${path}`;
            const params = new URLSearchParams();

            // Add SSE mode
            if (sseMode) {
                params.append('sseMode', sseMode);
            }

            // Add continuous mode parameters
            if (continuous) {
                params.append('continuous', 'true');
                if (interval) params.append('interval', interval);
                if (maxDuration) params.append('maxDuration', maxDuration);
            }

            if (queryString) {
                queryString.split('&').forEach(pair => {
                    const [key, value] = pair.split('=');
                    if (key) params.append(key, value || '');
                });
            }

            if (shape) {
                params.append('shape', shape);
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            // Start EventSource
            try {
                eventSource = new EventSource(url);
                startTime = Date.now();
                startDurationTimer();

                updateConnectionStatus('Streaming');
                startBtn.disabled = true;
                stopBtn.disabled = false;

                // Disable all quick-start buttons except active one
                setQuickButtonsEnabled(false);

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        // Handle continuous mode special events
                        if (data.type === 'info') {
                            displayChunk(`â„¹ï¸ INFO: ${data.message}\nMode: ${data.mode}, Interval: ${data.intervalMs}ms, Max Duration: ${data.maxDurationSeconds}s`, false);
                            return;
                        }

                        if (data.type === 'end') {
                            displayChunk(`ðŸ›‘ END: ${data.message}\nTotal events: ${data.eventCount}`, true);
                            updateConnectionStatus('Complete');
                            stopStream();
                            showStatus('Continuous stream ended');
                            return;
                        }

                        if (data.type === 'error') {
                            displayChunk(`âŒ ERROR: ${data.message} (event #${data.eventCount})`, true);
                            return;
                        }

                        // LlmTokens mode
                        if (data.chunk !== undefined) {
                            if (data.done) {
                                const batchInfo = data.batchNumber !== undefined ? ` [Batch #${data.batchNumber}]` : '';
                                displayChunk(`âœ“ COMPLETE${batchInfo}\n${data.content}`, true);
                                if (!continuousCheckbox.checked) {
                                    updateConnectionStatus('Complete');
                                    stopStream();
                                    showStatus('Stream completed successfully');
                                }
                            } else {
                                chunkCount++;
                                totalSize += data.chunk.length;
                                updateStats();
                                displayChunk(data.chunk);
                            }
                        }
                        // CompleteObjects mode
                        else if (data.data !== undefined) {
                            chunkCount++;
                            const jsonStr = JSON.stringify(data.data, null, 2);
                            totalSize += jsonStr.length;
                            updateStats();

                            const batchInfo = data.timestamp ? ` [${new Date(data.timestamp).toLocaleTimeString()}]` : '';
                            const display = `ðŸ“¦ Object #${data.index}${batchInfo}\n${jsonStr}`;
                            displayChunk(display, data.done);

                            if (data.done && !continuousCheckbox.checked) {
                                updateConnectionStatus('Complete');
                                stopStream();
                                showStatus('Stream completed successfully');
                            }
                        }
                        // ArrayItems mode
                        else if (data.item !== undefined) {
                            chunkCount++;
                            const jsonStr = JSON.stringify(data.item, null, 2);
                            totalSize += jsonStr.length;
                            updateStats();

                            const arrayInfo = data.arrayName ? ` from "${data.arrayName}"` : '';
                            const batchInfo = data.batchNumber !== undefined ? ` [Batch #${data.batchNumber}]` : '';
                            const display = `ðŸ“‹ Item ${data.index + 1}/${data.total}${arrayInfo}${batchInfo}\n${jsonStr}`;
                            displayChunk(display, data.done);

                            if (data.done && !continuousCheckbox.checked) {
                                updateConnectionStatus('Complete');
                                stopStream();
                                showStatus('Stream completed successfully');
                            }
                        }
                    } catch (err) {
                        console.error('Parse error:', err);
                        displayChunk(`Error: ${err.message}`, true);
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    showStatus('Stream error occurred', true);
                    updateConnectionStatus('Error');
                    stopStream();
                };

            } catch (err) {
                showStatus(`Failed to start stream: ${err.message}`, true);
                updateConnectionStatus('Disconnected');
            }
        });

        stopBtn.addEventListener('click', () => {
            stopStream();
            showStatus('Stream stopped');
        });

        function stopStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            stopDurationTimer();
            updateConnectionStatus('Disconnected');
            startBtn.disabled = false;
            stopBtn.disabled = true;

            // Re-enable all quick-start buttons and clear active state
            setActiveQuickButton(null, false);
            setQuickButtonsEnabled(true);
        }

        // Quick SSE button handlers
        document.querySelectorAll('.quick-sse-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // If this button is already streaming, stop it
                if (this === activeQuickButton && eventSource) {
                    stopStream();
                    return;
                }

                const path = this.getAttribute('data-path');
                const shape = this.getAttribute('data-shape');
                const mode = this.getAttribute('data-mode');
                const isContinuous = this.getAttribute('data-continuous') === 'true';
                const interval = this.getAttribute('data-interval');

                // Stop any existing stream first (ensures only one active)
                if (eventSource) {
                    stopStream();
                }

                // Set this button as the active one
                setActiveQuickButton(this, true);

                // Set form values
                document.getElementById('path').value = path;
                document.getElementById('shape').value = shape;
                if (mode) {
                    document.getElementById('sseMode').value = mode;
                }

                // Set continuous mode if specified
                document.getElementById('continuous').checked = isContinuous;
                continuousSettings.style.display = isContinuous ? 'block' : 'none';
                if (interval) {
                    document.getElementById('interval').value = interval;
                }

                // Trigger start
                setTimeout(() => startBtn.click(), 100);
            });
        });
    </script>
</body>
</html>
